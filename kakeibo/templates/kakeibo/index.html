{% extends "base.html" %}
{% block title %}家計簿カレンダー{% endblock %}

{% block head %}
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
        <style>
            .container {
                font-family: 'Noto Sans JP', sans-serif;
            }
            a {
                text-decoration: none;
            }
            th {
                height: 30px;
                text-align: center;
            }
            td {
                height: 100px;
            }
            .today {
                background: orange !important;
            }
            #prev, #month, #next {
                display: inline-block;
                vertical-align: middle;
                margin: 0;
            }
            td:not(:empty):hover {
                background-color: yellow;
            }
            #prev:hover {
                background-color: yellow;
            }
            #next:hover {
                background-color: yellow;
            }
            #form-container {
                display: none;
            }
            .col-sm-4 {
                padding-right: 70px;
            }
            .col-md-6.offset-md-3 {
                background-color: #fff; /* 背景色を設定 */
                background-image: url('/static/kakeibo.png'); /* 背景画像を追加 */
            }
            #month {
                padding-left: 20px;
                padding-right: 20px;
            }
            .col-sm-8.offset-sm-2.text-center {
                padding-bottom: 50px;
            }
            .first-table th:first-child, td:nth-child(7n+1) {
                color: red;
                border-color: black;
            }
            .first-table th:last-child, td:nth-child(7n) {
                color: blue;
                border-color: black;
            }
            .triangle-right{
                border-style: solid;
                border-width: 10px 0 10px 10px;
                border-color: transparent transparent transparent black;
                display: inline-block;
                width: 0;
                height: 0;
            }
            .triangle-left{
                border-style: solid;
                border-width: 10px 10px 10px 0;
                border-color: transparent black transparent transparent;
                display: inline-block;
                width: 0;
                height: 0;
            }
            .py-5 {
                padding-top: 1rem!important;
                padding-bottom: 3rem!important;
            }
        </style>
{% endblock %}
        
{% block main %}
    <main class="container-fluid py-5 text-center">
    <div class="first-table">
    <div class="container">
    <botton id="prev" class="triangle-left"></botton><h3 id="month"></h3><botton id="next" class="triangle-right"></botton>
    <p></p>
    <div id="calendar">
    <table class="table table-bordered">
        <tr>
            <th>日</th>
            <th>月</th>
            <th>火</th>
            <th>水</th>
            <th>木</th>
            <th>金</th>
            <th>土</th>
        </tr>
        <tbody id="calendar-body">
        </tbody>
    </table>
    </div>
    </div>
    </div>
    </main>
    <div id="form-register">
        <div class="col-md-6 offset-md-3">
        <br>
        <h3>～　入力フォーム　～</h3>
        <p></p><br>
        <form>
            <div class="form-group row">
                <label for="date" class="col-sm-2 col-form-label">日付</label>
                <div class="col-sm-4">
                    <input type="date" class="form-control" id="regist_date" name="date">
                </div>
                <!-- 品目の制限は後で加える -->
                <label for="name" class="col-sm-2 col-form-label">品目</label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" id="regist_name" name="name">
                </div>
                <p></p>
            </div>
            <div class="form-group row">
                <label for="price" class="col-sm-2 col-form-label">単価</label>
                <div class="col-sm-4">
                    <input type="number" class="form-control" id="regist_price" name="price" min="1">
                </div>
                <label for="date" class="col-sm-2 col-form-label">数量</label>
                <div class="col-sm-4">
                    <input type="number" class="form-control" id="regist_quantity" name="quantity" min="1">
                </div>
                <p></p><br>
                <div class="col-sm-8 offset-sm-2 text-center">
                    <button type="submit" class="btn-primary btn-lg" id="regist_btn">登録</button>
                </div>
            </div>
        </form>
        </div>
    </div>

    <p></p>
    <h3>～　支出一覧　～</h3>
    <table id="Habs_tb" class="container" style="width: 50%;">
        <tr>
            <th>日付</th>
            <th>品目</th>
            <th>税込価格</th>
        </tr>
    </table>
    <script>
        var today = new Date();
        var currentMonth = today.getMonth();
        var currentYear = today.getFullYear();
        //var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        var prevButton = document.getElementById("prev");
        var nextButton = document.getElementById("next");

        //前の月へ戻る
        prevButton.addEventListener("click", function() {
            currentYear = (currentMonth == 1) ? currentYear - 1 : currentYear;
            currentMonth = (currentMonth == 1) ? 12 : currentMonth - 1;
            displayCalendar();
        });

        //次の月へ進む
        nextButton.addEventListener("click", function() {
            currentYear = (currentMonth == 12) ? currentYear + 1 : currentYear;
            currentMonth = (currentMonth == 12) ? 1 : currentMonth + 1;
            displayCalendar();
        });

        function displayCalendar() {
            var firstDay = (new Date(currentYear, currentMonth)).getDay();
            var daysInMonth = 32 - new Date(currentYear, currentMonth, 32).getDate();

            var calendarBody = document.getElementById("calendar-body");
            calendarBody.innerHTML = "";

            var monthYear = document.getElementById("month");
            var month = currentMonth % 12 + 1;
            monthYear.innerHTML = currentYear + "年" + month + "月";

            var date = 1;
            for (var i = 0; i < 6; i++) {
                var row = document.createElement("tr");

                for (var j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        var cell = document.createElement("td");
                        var cellText = document.createTextNode("");
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                    } else if (date > daysInMonth) {
                        var cell = document.createElement("td");
                        var cellText = document.createTextNode("");
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                    } else {
                        var cell = document.createElement("td");
                        var cellText = document.createTextNode(date);
                        if (date === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                            cell.classList.add("today");
                        }
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                        date++;
                    }
                }
                calendarBody.appendChild(row);
                //週の終わりまで空の箱を用意する。
                if (date > daysInMonth) {
                    break;
                }
            }
        }
        displayCalendar();

        ///////////////////////////////////////////////////////////
        // ここは、まだやり方模索中
        // カレンダーの日付を表示するテーブルを取得
        var calendarBody = document.getElementById("calendar-body");

        // 日付セルにクリックイベントを追加する
        calendarBody.addEventListener("click", function(e) {
            // クリックされた要素がtd要素である場合にのみ処理を実行する
            if (e.target && e.target.nodeName === "TD") {
                // フォームを表示する
                var formContainer = document.getElementById("form-container");
                formContainer.style.display = "block";

                // フォームを日付セルの上に配置する
                var cellRect = e.target.getBoundingClientRect();
                var formHeight = formContainer.offsetHeight;
                formContainer.style.top = (cellRect.top - formHeight) + "px";
                formContainer.style.left = cellRect.left + "px";
            }
        });
        ///////////////////////////////////////////////////////////

        // 「登録」ボタンにイベントリスナーを設定
        getElmId("regist_btn").addEventListener('click', registSpending, false);
        // 「年月日」を配列で取得 ( [0]:年, [1]:月, [2]:日 )
        var dateArray = getTSDate(today);

        ////////  データベースの整合は後で考える　////////
        // This is WEBSQL (WebSQLは、非推奨らしいので、出来れば変えてほしい)
        // DB情報を設定
        var dbName = 'kakeibo';                                // DB名
        var dbVersion = '1.0';                                 // DBバージョン
        var dbDescription = 'kakeibo_register_database';       // DB説明文
        var dbSize = 100000;                                   // DBサイズ
        var db = openDatabase(dbName, dbVersion, dbDescription, dbSize);
        // テーブルが存在しない場合、テーブルを作成
        db.transaction(function(trns){
            trns.executeSql('create table if not exists Hab (id integer primary key autoincrement,name text not null,price int not null,quantity int not null,sum int not null,registed_at datetime)')
          }
        );
        ////////  データベースの整合は後で考える //////////
        
        // 登録日付に「本日の年月日」を設定
        document.getElementById("regist_date").value = dateArray[0] + "-" + dateArray[1] + "-" + dateArray[2]
        /* 計算したデータのテーブル(日付, 品目, 税込価格, 削除ボタン, 編集ボタン)を表示*/
        function execDisplayDesignatedPeriodData() {
            db.transaction(function (tx) {
                // SELECT文を実行
                tx.executeSql("select id, name, sum, registed_at from Hab ORDER BY registed_at DESC" , [],
                    function (tx, results) {
                        // テーブルを取得
                        var table = getElmId('Hab_tb');
                        // テーブルヘッダー生成
                        table.innerHTML = "<tr><th>日付</th><th>品目</th><th colspan='3'>税込価格</th></tr>";
                        for (i = 0; i < results.rows.length; i++){
                            var rowData = results.rows.item(i);
                            var displayData = document.createElement('tr');
                            // テーブル識別用id属性付加
                            displayData.setAttribute("id", rowData.id);
                            // テーブルデータ生成
                            displayData.innerHTML = '<td>' + rowData.registed_at.split(' ')[0] + '</td><td>' + rowData.name + '</td><td class="sum">'+ rowData.sum + '</td><td><button class="delete_btn">削除</button></td><td><button class="edit_btn">編集</button></td>';
                            // テーブルデータ追加
                            table.appendChild(displayData);
                        }
                        //「削除」ボタンにイベントリスナーを設定
                        var del_btns = getElmCls('delete_btn');
                        for(let btn of del_btns) {
                            btn.addEventListener('click', onClickDelBtn, false);
                        }
                        //「編集」ボタンにイベントリスナーを設定
                        var edit_btns = getElmCls('edit_btn');
                        for(let btn of edit_btns) {
                            btn.addEventListener('click', onClickEditBtn, false);
                        }
                   },
                   // エラー処理
                   function(transaction, error){
                       alert("データが取得できません。");
                   })
               }
           )
        }
        /* データ登録処理*/
        function registSpending(){
            // 入力データのチェック
            if( chkRegistData('regist_date','regist_name', 'regist_price', 'regist_quantity') ){
                db.transaction(
                    function(trans){
                        // INSERT文を実行
                        trans.executeSql('INSERT INTO Hab (name, price, quantity, sum, registed_at) VALUES (?,?,?,?,?);', [getElmId('regist_name').value, getElmId('regist_price').value, getElmId('regist_quantity').value, Math.floor(getElmId('regist_price').value * getElmId('regist_quantity').value * 1.1), getElmId('regist_date').value + " 00:00:01"],
                            function(){
                                // 表示データを更新
                                execDisplayDesignatedPeriodData();
                                //登録データ（品目・単価・個数）の入力ボックスの値を初期化
                                getElmId('regist_name').value = ""
                                getElmId('regist_price').value = ""
                                getElmId('regist_quantity').value = "";
                            },
                            // エラー処理
                            function(){
                                alert('データが追加できません。');
                            }
                        );
                    }
                );
            }
        }
        /* 登録データのチェック1 */
        function chkRegistData(date_id, name_id, price_id, quantity_id){
            var correctFlg = true;
            // 日付の書式チェック
            if ( getElmId(date_id).value.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/g) === null){
                alert('登録日付が正しくありません。');
                correctFlg = false;
            }
            // 品目のチェック
            if ( getElmId(name_id).value.length === 0 ){
                alert('品目を入力してください。');
                correctFlg = false;
            }
            // 単価のチェック
            if ( getElmId(price_id).value.length === 0 ){
                alert('単価を入力してください。');
                correctFlg = false;
            } else {
                // 単価の書式チェック
                if ( getElmId(price_id).value.match(/^[0-9]*$/g) === null ){
                    alert('単価が正しくありません。');
                    correctFlg = false;
                }
            }
            // 個数のチェック
            if ( getElmId(price_id).value.length === 0 ){
                alert('個数を入力してください。');
                correctFlg = false;
            } else {
                // 個数の書式チェック
                if ( getElmId(quantity_id).value.match(/^[0-9]*$/g) === null ){
                    alert('個数が正しくありません。');
                    correctFlg = false;
                }
            }
            return correctFlg;
        }
        /* 登録データのチェック2 */
        function chkRegistData2(date_id, name_id){
            var correctFlg = true;
            // 日付の書式チェック
            if ( getElmId(date_id).value.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/g) === null){
                alert('登録日付が正しくありません。');
                correctFlg = false;
            }
            // 品目のチェック
            if ( getElmId(name_id).value.length === 0 ){
                alert('品目を入力してください。');
                correctFlg = false;
            }
            return correctFlg;
        }
        /*「削除ボタン」クリック時の処理 */
        function onClickDelBtn(event){
            // データ削除の確認ダイアログ表示
            if( confirm("データを削除しますか？") ){
                // データ識別用id属性の値を取得
                var del_id = event.target.parentNode.parentNode.getAttribute("id");
                db.transaction(function(tx) {
                    // DELETE文を実行
                    tx.executeSql("delete from Hab where id='" + del_id + "'", [],
                        function () {
                            //データを表示
                            execDisplayDesignatedPeriodData();
                        },
                        // エラー処理
                        function () {
                            alert('データ削除失敗');
                        }
                    )}
                );
            }
        }
        /*「編集ボタン」クリック時の処理*/
        function onClickEditBtn(event){
            // データ識別用id属性の値を取得
            var edit_id = event.target.parentNode.parentNode.getAttribute("id");
            // id値のtd要素を取得
            var td = getElmId(edit_id).children;
            // テーブル要素を取得
            var table = getElmId('Hab_tb');
            // テーブルヘッダー作成
            table.innerHTML = "<tr><th>日付</th><th>内容</th><th colspan='3'>税込価格</th></tr>";
            // テーブル行を作成
            var displayData = document.createElement('tr');
            // データ識別用id属性を設定
            displayData.setAttribute("id", edit_id);
            // 編集用HTMLコード作成
            displayData.innerHTML = '<td><input type="date" id="edit_date" value="' + td[0].textContent.split(" ")[0] + '"></td><td><input type="text" id="edit_name" value="' + td[1].textContent + '"></td><td>' + td[2].textContent + '</td><td><button id="edit_exec_btn">編集実行</button></td>';
            //編集用HTMLコードをテーブルに設定
            table.appendChild(displayData);
            // 「編集実行」ボタンにイベントリスナーを設定
            getElmId('edit_exec_btn').addEventListener('click', onClickEditExecBtn, false);
        }
        /* データ更新処理 */
        function onClickEditExecBtn(event){
            if ( chkRegistData2('edit_date', 'edit_name') ){
                // データ識別用id属性の値を取得
                var edit_id = event.target.parentNode.parentNode.getAttribute("id");
                // 登録用「年月日」時間を作成
                var regist_date = getElmId('edit_date').value + ' 00:00:01';
                db.transaction(function(tx) {
                    // UPDATE文を実行
                    tx.executeSql("update Hab set name = '" + getElmId('edit_name').value + "', registed_at = '" + regist_date + "' where id='" + edit_id + "'", [],
                        function () {
                            //データを表示
                            execDisplayDesignatedPeriodData();
                            alert('データを更新しました。');
                        },
                        // エラー処理
                        function () {
                            alert('データが更新できません。');
                        }
                    )}
                );
            }
        }
        /* ID名からDOMを取得 */
        function getElmId(id){
            return document.getElementById(id);
        }
        /* Class名からDOMを取得 */
        function getElmCls(contents){
            return document.getElementsByClassName(contents);
        }
        /* タイムスタンプから年月日文字列を取得 */       
        function getTSDate(date){
            var dateArray = new Array();
            dateArray.push(zero_pad(date.getFullYear(),4));
            dateArray.push(zero_pad(date.getMonth() + 1,2));
            dateArray.push(zero_pad(date.getDate(),2));
            return dateArray;
        }
        /* ０詰処理 */
        function zero_pad(val, show_length){
            var str_val = String(val);
            if( str_val.length < show_length ){
                var zero = ""; 
                for(var i = 0; i < ( show_length - str_val.length ); i++){
                    zero += "0";
                }
                str_val = zero + str_val;
            }
            return str_val;
        };

    </script>
{% endblock %}
