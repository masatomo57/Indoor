{% extends "base.html" %}
{% block title %}データ登録{% endblock %}

{% block main %}
      <!-- 登録項目: 日時、品目、単価、個数 -->
        <div id="regist_spending" class="container">
            <h2>データ登録</h2>
            <table id="regist_data_tb">
                <tr><td>日付</td><td><input type="date" id="regist_date" style="width: 100%;"></td></tr>
                <tr><td>品目</td><td><input type="text" id="regist_contents" required></td></tr>
                <tr><td>単価</td><td><input type="number" id="regist_price" min="1"></td></tr>
                <tr><td>個数</td><td><input type="number" id="regist_quantity" min="1"></td></tr>
                <tr><td colspan="2"><button id="regist_spending_btn">計算</button></td></tr>
            </table>
        </div>
        <table id="habs_tb" class="container" style="width: 50%;">
            <tr>
                <th>日付</th>
                <th>品目</th>
                <th>合計金額</th>
            </tr>
        </table>
    <!-- 入力されたデータを登録する画面 -->
    <form action="/register" method="post">
        <button class="btn btn-primary" type="submit">登録</button>
    </form>

    <script>
        var date = new Date();
        // 「年月日」を配列で取得 ( [0]:年, [1]:月, [2]:日 )
        var dateArray = getTSDate(date);

        ////////  データベースの整合は後で考える　////////
        // This is WEBSQL
        // DB情報を設定
        var dbName = 'household_account_book';                 // DB名
        var dbVersion = '1.0';                                 // DBバージョン
        var dbDescription = 'household_account_book_database'; // DB説明文
        var dbSize = 100000;                                   // DBサイズ
        var db = openDatabase(dbName, dbVersion, dbDescription, dbSize);
        // テーブルが存在しない場合、テーブルを作成
        db.transaction(function(trns){
            trns.executeSql('create table if not exists habs (id integer primary key autoincrement,contents text not null,price int not null,quantity int not null,sum int not null,registed_at datetime)')
          }
        );
        ////////  データベースの整合は後で考える //////////

        // 登録日付に「本日の年月日」を設定
        document.getElementById("regist_date").value = dateArray[0] + "-" + dateArray[1] + "-" + dateArray[2]
        /* 計算したデータのテーブル(日付, 品目, 合計金額)を表示*/
        function execDisplayDesignatedPeriodData() {
            db.transaction(function (tx) {
                // SELECT文を実行
                tx.executeSql("select id, contents, sum, registed_at from habs ORDER BY registed_at ASC" , [],
                    function (tx, results) {
                        // テーブルを取得
                        var table = getElmId('habs_tb');
                        // テーブルヘッダー生成
                        table.innerHTML = "<tr><th>日付</th><th>品目</th><th colspan='3'>税込価格</th></tr>";
                        for (i = 0; i < results.rows.length; i++){
                            var rowData = results.rows.item(i);
                            var displayData = document.createElement('tr');
                            // テーブル識別用id属性付加
                            displayData.setAttribute("id", rowData.id);
                            // テーブルデータ生成
                            displayData.innerHTML = '<td>' + rowData.registed_at.split(' ')[0] + '</td><td>' + rowData.contents + '</td><td class="sum">'+ rowData.sum + '</td><td><button class="delete_btn">削除</button></td><td><button class="edit_btn">編集</button></td>';
                            // テーブルデータ追加
                            table.appendChild(displayData);
                        }
                        //「削除」ボタンにイベントリスナーを設定
                        var del_btns = getElmCls('delete_btn');
                        for(let btn of del_btns) {
                            btn.addEventListener('click', onClickDelBtn, false);
                        }
                        //「編集」ボタンにイベントリスナーを設定
                        var edit_btns = getElmCls('edit_btn');
                        for(let btn of edit_btns) {
                            btn.addEventListener('click', onClickEditBtn, false);
                        }
                   },
                   // エラー処理
                   function(transaction, error){
                       alert("データが取得できません。");
                   })
               }
           )
        }
        /* データ登録処理*/
        function registSpending(){
            // 入力データのチェック
            if( chkRegistData('regist_date','regist_contents', 'regist_price', 'regist_quantity') ){
                db.transaction(
                    function(trans){
                        // INSERT文を実行
                        trans.executeSql('INSERT INTO habs (contents, price, quantity, sum, registed_at) VALUES (?,?,?,?,?);', [getElmId('regist_contents').value, getElmId('regist_price').value, getElmId('regist_quantity').value, Math.floor(getElmId('regist_price').value * getElmId('regist_quantity').value * 1.1), getElmId('regist_date').value + " 00:00:01"],
                            function(){
                                // 表示データを更新
                                execDisplayDesignatedPeriodData();
                                //登録データ（品目・単価・個数）の入力ボックスの値を初期化
                                getElmId('regist_contents').value = ""
                                getElmId('regist_price').value = ""
                                getElmId('regist_quantity').value = "";
                            },
                            // エラー処理
                            function(){
                                alert('データが追加できません。');
                            }
                        );
                    }
                );
            }
        }
        /* 登録データのチェック */
        function chkRegistData(date_id, contents_id, price_id, quantity_id){
            var correctFlg = true;
            // 日付の書式チェック
            if ( getElmId(date_id).value.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/g) === null){
                alert('登録日付が正しくありません。');
                correctFlg = false;
            }
            // 品目のチェック
            if ( getElmId(contents_id).value.length === 0 ){
                alert('品目を入力してください。');
                correctFlg = false;
            }
            // 単価のチェック
            if ( getElmId(price_id).value.length === 0 ){
                alert('適切な値を入力してください。');
                correctFlg = false;
            } else {
                // 単価の書式チェック
                if ( getElmId(price_id).value.match(/^[0-9]*$/g) === null ){
                    alert('値が正しくありません。');
                    correctFlg = false;
                }
            }
            // 個数のチェック
            if ( getElmId(price_id).value.length === 0 ){
                alert('適切な値を入力してください。');
                correctFlg = false;
            } else {
                // 個数の書式チェック
                if ( getElmId(quantity_id).value.match(/^[0-9]*$/g) === null ){
                    alert('値が正しくありません。');
                    correctFlg = false;
                }
            }
            return correctFlg;
        }
        /*「削除ボタン」クリック時の処理 */
        function onClickDelBtn(event){
            // データ削除の確認ダイアログ表示
            if( confirm("データを削除しますか？") ){
                // データ識別用id属性の値を取得
                var del_id = event.target.parentNode.parentNode.getAttribute("id");
                db.transaction(function(tx) {
                    // DELETE文を実行
                    tx.executeSql("delete from habs where id='" + del_id + "'", [],
                        function () {
                            //データを表示
                            execDisplayDesignatedPeriodData();
                        },
                        // エラー処理
                        function () {
                            alert('データ削除失敗');
                        }
                    )}
                );
            }
        }
        /*「編集ボタン」クリック時の処理*/
        function onClickEditBtn(event){
            // データ識別用id属性の値を取得
            var edit_id = event.target.parentNode.parentNode.getAttribute("id");
            // id値のtd要素を取得
            var td = getElmId(edit_id).children;
            // テーブル要素を取得
            var table = getElmId('habs_tb');
            // テーブルヘッダー作成
            table.innerHTML = "<tr><th>日付</th><th>内容</th><th colspan='3'>税込価格</th></tr>";
            // テーブル行を作成
            var displayData = document.createElement('tr');
            // データ識別用id属性を設定
            displayData.setAttribute("id", edit_id);
            // 編集用HTMLコード作成
            displayData.innerHTML = '<td><input type="date" id="edit_date" value="' + td[0].textContent.split(" ")[0] + '"></td><td><input type="text" id="edit_contents" value="' + td[1].textContent + '"></td><td><input type="number" id="edit_sum" value="' + td[2].outerText + '"></td><td></td><td><button id="edit_exec_btn">編集実行</button></td>';
            //編集用HTMLコードをテーブルに設定
            table.appendChild(displayData);
            // 「編集実行」ボタンにイベントリスナーを設定
            getElmId('edit_exec_btn').addEventListener('click', onClickEditExecBtn, false);
        }
        /* データ更新処理 */
        function onClickEditExecBtn(event){
            if ( chkRegistData('edit_date', 'edit_contents', 'edit_sum', 'edit_sum') ){
                // データ識別用id属性の値を取得
                var edit_id = event.target.parentNode.parentNode.getAttribute("id");
                // 登録用「年月日」時間を作成
                var regist_date = getElmId('edit_date').value + ' 00:00:01';
                db.transaction(function(tx) {
                    // UPDATE文を実行
                    tx.executeSql("update habs set contents = '" + getElmId('edit_contents').value + "', sum = '" + getElmId('edit_sum').value + "', registed_at = '" + regist_date + "' where id='" + edit_id + "'", [],
                        function () {
                            //データを表示
                            execDisplayDesignatedPeriodData();
                            alert('データを更新しました。');
                        },
                        // エラー処理
                        function () {
                            alert('データが更新できません。');
                        }
                    )}
                );
            }
        }
        /* ID名からDOMを取得 */
        function getElmId(id){
            return document.getElementById(id);
        }
        /* Class名からDOMを取得 */
        function getElmCls(contents){
            return document.getElementsByClassName(contents);
        }
        /* タイムスタンプから年月日文字列を取得 */       
         function getTSDate(date){
            var dateArray = new Array();
            dateArray.push(zero_pad(date.getFullYear(),4));
            dateArray.push(zero_pad(date.getMonth() + 1,2));
            dateArray.push(zero_pad(date.getDate(),2));
            return dateArray;
        }
        /* ０詰処理 */
         function zero_pad(val, show_length){
            var str_val = String(val);
            if( str_val.length < show_length ){
                var zero = ""; 
                for(var i = 0; i < ( show_length - str_val.length ); i++){
                    zero += "0";
                }
                str_val = zero + str_val;
            }
            return str_val;
        };
        // 「計算」ボタンにイベントリスナーを設定
        getElmId("regist_spending_btn").addEventListener('click', registSpending, false);
    </script>
{% endblock %}